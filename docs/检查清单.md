# 批处理运行前检查清单

在运行 `batch_extract_batch*.sh` 脚本前，请逐项确认以下内容：

---

## 硬件环境

- [ ] **电脑保持充电状态**
  - 长时间运行任务（数小时），必须接通电源
  - 检查：电池图标显示充电中

- [ ] **外置硬盘已挂载**
  - 视频源文件在外置硬盘上
  - 检查：`ls /Volumes/LQ1000/DJI_4K`

---

## API 与网络

- [ ] **智谱 API 余额充足**
  - 登录 [智谱开放平台](https://open.bigmodel.cn/) 查看余额
  - 建议：余额 > 100 元（每批次约消耗 30-50 元）
  - 检查：`echo $ZAI_API_KEY` 确认环境变量已设置

- [ ] **网络连接稳定**
  - API 调用需要稳定的网络
  - 建议：使用有线网络或稳定的 Wi-Fi

---

## 磁盘空间

- [ ] **剩余磁盘空间充足**
  - 检查：`df -h /`
  - 建议：可用空间 > 50 GB
  - 单批次峰值占用约 15-20 GB

- [ ] **中间文件已清理**
  - 检查：`du -sh dataset_output raw_data/videos/clips`
  - 清理：`rm -rf dataset_output/* raw_data/videos/clips/DJI_*`

---

## 并发与性能

- [ ] **并发限制 ≤ 10**
  - 脚本默认：`xargs -P 2`（2 个视频片段并行）
  - 每个片段：`--workers 4`（4 个异步请求）
  - 总并发：2 × 4 = 8 ≤ 10
  - 同时运行多个批次时注意总并发数

- [ ] **CPU/内存资源充足**
  - 检查：活动监视器
  - 建议：关闭其他占用资源的应用

---

## 质量保证

- [ ] **抽帧配置正确**
  - 仅抽取 I 帧（关键帧）：`--jpeg-frames` 参数
  - 输出格式：JPEG `-q:v 2`（最高质量，范围 2-31）
  - 验证：脚本中包含 `--jpeg-frames` 参数

- [ ] **裁剪过程无质量损失**
  - 输出格式：PNG 无损
  - 验证：`extracted_signs/` 下文件为 `.png` 格式

---

## 运行命令

确认以上检查项后，执行：

```bash
# 激活环境
cd /Users/justin/Desktop/GLM_Labeling
source venv/bin/activate

# 设置 API Key（如未设置）
export ZAI_API_KEY="your-api-key"

# 运行批处理（三选一或多终端并行）
bash scripts/batch_extract_batch3.sh
bash scripts/batch_extract_batch4.sh
bash scripts/batch_extract_batch5.sh
```

---

## 运行中监控

- 观察终端输出，确认每个视频片段正常处理
- 定期检查磁盘空间：`df -h /`
- 检查 API 余额（如运行时间过长）

---

## 常见问题

| 问题 | 原因 | 解决方案 |
|------|------|----------|
| 脚本中断无输出 | API 余额不足 | 充值后清理重跑 |
| 磁盘空间不足 | 中间文件累积 | 清理 `dataset_output/` 和 `clips/` |
| 网络超时 | 连接不稳定 | 检查网络，重新运行 |
| 视频文件找不到 | 硬盘未挂载 | 重新挂载外置硬盘 |

---

*最后更新：2025-12-23*
