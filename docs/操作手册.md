# 交通标志分类器训练操作手册

> 基于 2000 张人工标注数据训练交通标志分类模型

---

## 一、当前数据概况

### 已准备数据

| 数据 | 路径 | 说明 |
|------|------|------|
| 标注数据集 | `extracted_signs/labeled_data/` | 2000 张 PNG 图片 |
| 压缩包 | `extracted_signs/labeled_data.zip` | 107 MB |
| 标签文件 | `extracted_signs/labeled_data/dataset.json` | 包含所有标签 |
| 原始标注结果 | `extracted_signs/label_results.json` | 1690 张 valid 图片标注 |
| 筛选结果 | `extracted_signs/filter_results.json` | 3331 张图片筛选记录 |

### 数据集构成

| 来源 | 数量 | 标签 |
|------|------|------|
| valid (人工标注) | 1,690 | 56 种交通标志标签 |
| unclear | 310 | 标签为 "unclear" |
| **总计** | **2,000** | **57 种标签** |

### 标签分布 (Top 10)

| 标签 | 数量 |
|------|------|
| Direction_sign | 446 |
| other | 381 |
| unclear | 310 |
| Sharp_deviation_of_route_to_left | 85 |
| Speed_limit_(in_km_h) | 76 |
| Pedestrian_crossing_ahead | 73 |
| Keep_right | 64 |
| Risk_of_falling_or_fallen_rocks_ahead | 46 |
| No_entry_for_all_vehicles | 46 |
| Bend_to_left_ahead | 45 |

---

## 二、环境准备

### 1. 进入项目目录并激活虚拟环境

```bash
cd /Users/justin/Desktop/GLM_Labeling
source venv/bin/activate
```

### 2. 验证环境

```bash
python3 -c "import torch; print(f'PyTorch: {torch.__version__}')"
python3 -c "import chromadb; print('ChromaDB OK')"
```

### 3. 设置 API Key (如需 VLM 推理)

```bash
export ZAI_API_KEY="your_api_key_here"
```

---

## 三、现有分类器

### 1. DINOv2 分类器 (向量检索)

基于 188 种参考标志的向量相似度匹配。

**建立向量库（首次使用）：**
```bash
python3 scripts/dinov2_classifier.py --build --all-signs
```

**测试分类：**
```bash
python3 scripts/dinov2_classifier.py --test path/to/sign.jpg --top-k 5
```

### 2. CLIP 分类器

```bash
python3 scripts/clip_rag_classifier.py --test path/to/sign.jpg
```

---

## 四、下一步：训练分类头

### 方案概述

使用 2000 张人工标注数据，在 DINOv2 特征之上训练一个轻量分类头（MLP），提升分类准确率。

### 训练脚本 (待实现)

```bash
# 数据准备：划分训练集/验证集
python3 scripts/prepare_training_data.py \
    --input extracted_signs/labeled_data \
    --output training_data \
    --split 0.8

# 训练分类头
python3 scripts/train_classifier.py \
    --data training_data \
    --backbone dinov2 \
    --epochs 50 \
    --batch-size 32

# 评估模型
python3 scripts/eval_classifier.py \
    --model checkpoints/best_model.pth \
    --test-data training_data/val
```

### 预期产出

| 产出 | 路径 | 说明 |
|------|------|------|
| 训练好的模型 | `checkpoints/best_model.pth` | 分类头权重 |
| 训练日志 | `logs/training.log` | 损失和准确率曲线 |
| 评估报告 | `reports/eval_report.md` | 各类别准确率 |

---

## 五、标注工具

### 1. 4K 图片筛选 UI

用于筛选检测到的图片 (valid / unclear / not_sign)

```bash
python3 scripts/sign_filter_ui.py --port 8081
```

打开浏览器：http://localhost:8081

**快捷键：**
- `V` - 标记为 valid
- `U` - 标记为 unclear
- `N` - 标记为 not_sign
- `←` `→` - 上一张/下一张
- `S` - 保存

### 2. 细粒度标注 UI

用于对 valid 图片标注具体交通标志类别

```bash
python3 scripts/sign_labeling_ui.py --port 8082
```

打开浏览器：http://localhost:8082

**快捷键：**
- `/` - 搜索标志
- `Z` - 撤销
- `←` `→` - 上一张/下一张
- `Q` - 保存

---

## 六、文件结构

```
GLM_Labeling/
├── extracted_signs/
│   ├── labeled_data/           # 2000 张标注数据集
│   │   ├── *.png               # 图片文件
│   │   └── dataset.json        # 标签文件
│   ├── labeled_data.zip        # 压缩包 (107MB)
│   ├── label_results.json      # 1690 张 valid 标注
│   ├── filter_results.json     # 3331 张筛选结果
│   └── DJI/                    # 原始提取的标志图片
│
├── raw_data/
│   └── signs/                  # 188 种参考标志图片
│
├── scripts/
│   ├── sign_filter_ui.py       # 筛选 UI
│   ├── sign_labeling_ui.py     # 标注 UI
│   ├── dinov2_classifier.py    # DINOv2 分类器
│   ├── clip_rag_classifier.py  # CLIP 分类器
│   └── create_dataset.py       # 数据集生成脚本
│
└── docs/
    ├── 操作手册.md              # 本文档
    ├── WORKFLOW_MANUAL.md       # 视频处理工作手册
    └── DINOV2_CLASSIFIER.md     # DINOv2 分类器文档
```

---

## 七、常用命令速查

### 环境设置
```bash
cd /Users/justin/Desktop/GLM_Labeling
source venv/bin/activate
```

### 启动标注 UI
```bash
# 筛选 UI
python3 scripts/sign_filter_ui.py --port 8081

# 标注 UI
python3 scripts/sign_labeling_ui.py --port 8082
```

### 生成数据集
```bash
python3 scripts/create_dataset.py
```

### DINOv2 分类测试
```bash
# 建库
python3 scripts/dinov2_classifier.py --build --all-signs

# 测试
python3 scripts/dinov2_classifier.py --test path/to/sign.jpg
```

### 查看数据统计
```bash
# 查看标签分布
python3 -c "import json; d=json.load(open('extracted_signs/labeled_data/dataset.json')); print(f'总数: {d[\"total_images\"]}'); [print(f'{k}: {v}') for k,v in list(d['label_statistics'].items())[:10]]"

# 统计图片数量
ls extracted_signs/labeled_data/*.png | wc -l
```

---

*最后更新: 2025-12-21*
